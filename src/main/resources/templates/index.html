<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head>
	<object th:include="fragments/head :: sharedHeadContent" th:remove="tag"></object>
	<script th:src="${global_baseUrl} + '/static/js/maps.js'"></script>		
	<script>
		PubSub.subscribe("global.carpoolApp.ready", function() {
			// init google maps map, add click handler to pubsub event publishing
			var height = screen.height * 0.7;
			if(!height || height<400) {
				height = 400;
			}
			if(height > 1000) {
				height = 800;
			}
			$("#mapContainer").css("height", height);
			window.carpoolApp.mainMap = new google.maps.Map(document.getElementById('mapContainer'), { center: { lat: 49.8327787, lng: 23.9421959 }, zoom: 16 });
			centerMapOnCurrentLocation();
			
			window.carpoolApp.geocoder = new google.maps.Geocoder;
			
			window.carpoolApp.mainMap.addListener("click", function(event) {
				PubSub.publish("global.mainMap.clicked", event);
			});
			
			updateMyLiftRequests();
		});

		window.carpoolApp.loadedModules = [];
		PubSub.subscribe("global.module.load", function(moduleName) {
			window.carpoolApp.loadedModules.push(moduleName);
			if(window.carpoolApp.loadedModules.length == 2) {
				PubSub.publish("global.carpoolApp.ready");
			}
		});
		
		function onGoogleMapsLoad() {
			PubSub.publish("global.module.load.googleMaps");
		}
		
		$(document).ready(function () {
			PubSub.publish("global.module.load.document");
		});
		
		PubSub.subscribe("global.mainMap.clicked", function(msg, event) {
			console.log('clicked at ' + event.latLng.lat() + ":" + event.latLng.lng());
			$("#requestLiftForm_lat").val(event.latLng.lat());
			$("#requestLiftForm_lng").val(event.latLng.lng());
			$("#requestLiftButton").removeAttr("disabled");
			
			if(window.carpoolApp.liftRequestMarker) {
				window.carpoolApp.liftRequestMarker.setMap(null);
			}
			window.carpoolApp.liftRequestMarker = new google.maps.Marker({ 
					position: event.latLng, 
					map: window.carpoolApp.mainMap, 
					draggable: false,
					animation: google.maps.Animation.BOUNCE,
					clickable: false,
					icon: {
						path: google.maps.SymbolPath.BACKWARD_CLOSED_ARROW,
						scale: 6,
						fillColor: "green",
						strokeColor: "black",
						fillOpacity: 1,
						strokeWeight: 1
					}
				});
			
			window.carpoolApp.geocoder.geocode({location:event.latLng}, function(results, status) {
				if(status === 'OK' && results && results.length > 0) {
					$("#requestLiftForm_address").val(results[0]['formatted_address']);
				}
			});
		});
		
		function doRequestLift() {
			var now = new Date();
			var startH = now.getHours();
			var startM = now.getMinutes();
			var endH = (startH + 1 ) % 24;
			var endM = startM;
			var content = [];
			// FIXME: jsrender tempalte, localize
			content.push('<div class="row"><h5>Запит підвезти</h5></div>');
			content.push('<div class="row"><div class="twelve columns"><b>Координати</b>: ' + $("#requestLiftForm_lat").val() + '&nbsp;:&nbsp;' + $("#requestLiftForm_lng").val() + '</div></div>');
			content.push('<div class="row"><div class="twelve columns"><b>Адреса</b>: ' + $("#requestLiftForm_address").val() + '</div></div>');
			content.push('<div class="row"><div class="twelve columns"><b>Дійсний</b></div></div>');
			content.push('<div class="row"><div class="six columns">від (год/хв)</div><div class="six columns">до (год/хв)</div></div>');
			content.push('<div class="row">');
			content.push('<div class="three columns"><select class="u-full-width" id="liftRequestStartTimeH" onkeyup="fixNumericInput(this, 2)">');
			for(var i=0;i<24;i++) { content.push('<option value="'+i+'" '+ (i == startH? 'selected="selected"':'') + '>' + (i<10? '0' + i : '' + i) + '</option>'); }
			content.push('</select></div>');
			content.push('<div class="three columns"><select class="u-full-width" id="liftRequestStartTimeM" onkeyup="fixNumericInput(this, 2)">');
			for(var i=0;i<60;i++) { content.push('<option value="'+i+'" '+ (i == startM? 'selected="selected"':'') + '>' + (i<10? '0' + i : '' + i) + '</option>'); }
			content.push('</select></div>');
			content.push('<div class="three columns"><select class="u-full-width" id="liftRequestEndTimeH" onkeyup="fixNumericInput(this, 2)">');
			for(var i=0;i<24;i++) { content.push('<option value="'+i+'" '+ (i == endH? 'selected="selected"':'') + '>' + (i<10? '0' + i : '' + i) + '</option>'); }
			content.push('</select></div>');
			content.push('<div class="three columns"><select class="u-full-width" id="liftRequestEndTimeM" onkeyup="fixNumericInput(this, 2)">');
			for(var i=0;i<60;i++) { content.push('<option value="'+i+'" '+ (i == endM? 'selected="selected"':'') + '>' + (i<10? '0' + i : '' + i) + '</option>'); }
			content.push('</select></div>');
			content.push('</div>');
			content.push('<div class="row"><div class="twelve columns"><b>Примітки</b></div></div>');
			content.push('<div class="row"><div class="twelve columns"><input class="u-full-width" type="text" id="liftRequestNotes" /></div></div>');
			
			// TODO: validate start/end time
			showConfirmation(content.join('\n'), 'label.cancel', 'label.create', function() {
				var startDate = new Date();
				startDate.setHours($("#liftRequestStartTimeH").val());
				startDate.setMinutes($("#liftRequestStartTimeM").val());
				var endDate = new Date();
				endDate.setHours($("#liftRequestEndTimeH").val());
				endDate.setMinutes($("#liftRequestEndTimeM").val());
				var data = {
						lat : $("#requestLiftForm_lat").val(),
						lon : $("#requestLiftForm_lng").val(),
						address : $("#requestLiftForm_address").val(),
						timeValidFrom : date2unixts(startDate),
						timeValidTo :  date2unixts(endDate),
						notes : $("#liftRequestNotes").val()
					};
				
				makeApiCall("/api/liftrequest", 'POST', data, function(genericResultDto) {
					showPopup(window.carpoolApp.l10n['label.liftrequest.createsuccess']);
					updateMyLiftRequests();
				});				
			}, true);
		}
		
		function fmtDateShortest(date) {
			var result = '';
			var now = new Date();
			if(date.getYear() != now.getYear()) {
				result += (date.getYear()+1900) + ' ' + window.carpoolApp.l10n['month.short.'+date.getMonth()] + '/' + date.getDate() + ' ';
			} else if(date.getMonth() != now.getMonth() || date.getDate() != now.getDate()) {
				result += window.carpoolApp.l10n['month.short.'+date.getMonth()] + '/' + date.getDate() + ' ';
			}
			result += date.getHours() + ':' + date.getMinutes();
			return result;
		}
		
		function updateMyLiftRequests() {
			if(window.carpoolApp.liftRequestMarkers) {
				for(var kidx in Object.keys(window.carpoolApp.liftRequestMarkers)) {
					showHideLiftRequestOnMap(false, Object.keys(window.carpoolApp.liftRequestMarkers)[kidx]);
				}
			}
			window.carpoolApp.liftRequestMarkers = {};
			$("#myLiftRequestsContainer").html('<div class="u-full-width" style="text-align: center"><i class="fa fa-circle-o-notch fa-spin fa-fw"></i></div>');
			makeApiCall("/api/liftrequest?ownOnly=true&activeOnly=true", 'GET', null, function(liftRequests) {
				$("#myLiftRequestsContainer").html('');
				for(var idx in liftRequests) {
					liftRequests[idx].indexInList = idx;
					liftRequests[idx].color = uniqueColor(idx);
					liftRequests[idx].validFrom = fmtDateShortest(unixts2date(liftRequests[idx].timeValidFrom));
					liftRequests[idx].validTo = fmtDateShortest(unixts2date(liftRequests[idx].timeValidTo));
					$("#myLiftRequestsContainer").append($.templates("#liftRequestListRowTemplate").render(liftRequests[idx]));
				}
			}, function(xhr, status, error) { $("#myLiftRequestsContainer").html(xhr.responseJSON? (exclamationSign + " " + xhr.responseJSON.message) : (exclamationSign + " " + xhr.statusText + " " + xhr.status)); })
		}
		
		function deleteLiftRequest(liftRequestId) {
			formSubmitBtnSetState("btnDeleteLiftRequest_" + liftRequestId, true, true);
			makeApiCall("/api/liftrequest/" + liftRequestId, 'DELETE', null, function(vehicleDto) {
				$("#liftRequestsList_" + liftRequestId).remove();
				showHideLiftRequestOnMap(false, liftRequestId);
			}, null, function() {
				formSubmitBtnSetState("btnDeleteLiftRequest_" + liftRequestId, false, false);
			});
		}
		
		function showHideLiftRequestOnMap(show, liftRequestId, lat, lng, color) {
			if(show) {
				window.carpoolApp.liftRequestMarkers[liftRequestId] = new google.maps.Marker({ 
					position: new google.maps.LatLng(lat, lng), 
					map: window.carpoolApp.mainMap, 
					draggable: false,
					clickable: false,
					icon: {
						path: google.maps.SymbolPath.BACKWARD_OPEN_ARROW,
						scale: 5,
						fillColor: color,
						strokeColor: color,
						fillOpacity: 1,
						strokeWeight: 1
					}
				});
				window.carpoolApp.mainMap.setCenter(new google.maps.LatLng(lat, lng));
			} else {
				if(window.carpoolApp.liftRequestMarkers[liftRequestId]) {
					window.carpoolApp.liftRequestMarkers[liftRequestId].setMap(null);
				}
			}
		}
	</script>
	<script th:src="'https://maps.googleapis.com/maps/api/js?libraries=places&callback=onGoogleMapsLoad&language=' + ${#locale.getLanguage()}"></script>
</head>
<body>
	<div class="container">
		<div th:replace="fragments/common_heading :: commonHeading"></div>
		<div class="row">
			<div class="eight columns">
				<button class="u-full-width" onclick="centerMapOnCurrentLocation()" th:text="#{label.center_on_my_location}"></button>
				<div id="mapContainer"></div>
			</div>
			<div class="four columns">
				<!-- FIXME: localize, implement -->
				<button class="u-full-width" onclick="">offer lift</button>
				<hr/>
				<h5 th:text="#{label.chosen_location}"/></h5>
				<div id="requestLiftForm" style="display: block" class="u-full-width">
					<label class="u-full-width" th:text="#{label.coordinates}"></label>
					<input readonly="readonly" id="requestLiftForm_lat" style="width: 46%" type="text" />
					<input readonly="readonly" id="requestLiftForm_lng" style="width: 46%" type="text" />
					<label class="u-full-width" th:text="#{label.address}"></label>
					<input readonly="readonly" id="requestLiftForm_address" class="u-full-width" type="text" />
				</div>
				<button class="u-full-width" onclick="doRequestLift()" id="requestLiftButton" disabled="disabled" th:text="#{label.request_lift}"></button>
				<hr/>
				<h5 th:text="#{label.my_lift_requests}"/></h5>
				<script type="text/x-jsrender" id="liftRequestListRowTemplate">
					<div class="u-full-width" id="liftRequestsList_{{:id}}">
						<div>
							<button id="btnDeleteLiftRequest_{{:id}}" class="narrow" onclick="deleteLiftRequest({{:id}})">X <i class="waitIndicator fa fa-circle-o-notch fa-spin fa-fw"></i></button>
							<input type="checkbox" onclick="showHideLiftRequestOnMap(this.checked, {{:id}}, {{:lat}}, {{:lon}}, '{{:color}}')" />&nbsp;[[ #{label.show_on_map} ]]
							<span style="color: {{:color}}; display: inline-block"><i class="fa fa-map-marker" aria-hidden="true"></i></span>
						</div>
						<div>{{:address}}</div>
						<div>{{:validFrom}}&nbsp;-&nbsp;{{:validTo}}</div>
						<div>{{:notes}}</div>
						<hr class="halfWidth" />			
					</div>					
				</script>
				<div id="myLiftRequestsContainer" class="u-full-width">
					<div class="u-full-width" style="text-align: center"><i class="fa fa-circle-o-notch fa-spin fa-fw"></i></div>
				</div>
			</div>
		</div>
	</div>
</body>
</html>
